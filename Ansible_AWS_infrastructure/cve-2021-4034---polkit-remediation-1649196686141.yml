---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# CVE-2021-4034 - polkit-remediation
# https://console.redhat.com/insights/remediations/626f5cb4-4415-49f7-a4cf-cf70686faeb7
# Generated by Red Hat Insights on Tue, 05 Apr 2022 22:11:26 GMT
# Created by lvazquez-r3dh4t

# Fixes vulnerabilities:CVE-2021-4034:CVE_2021_4034_polkit|CVE_2021_4034_POLKIT
# Identifier: (vulnerabilities:CVE-2021-4034:CVE_2021_4034_polkit|CVE_2021_4034_POLKIT,fix)
# Version: 18927aee53a559399865108d9b2bf17d803d870e
# CVE-2021-4034 Mitigation Playbook v.1.1

# Copyright (c) 2022  Red Hat, Inc.
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# Warning! Be sure to download the latest version of this script from its primary source:
# https://access.redhat.com/security/vulnerabilities/RHSB-2022-001

# This playbook will install systemtap utilities and create a systemtap script to prevent
# pkexec from being executed with an empty first argument. The script will need to be
# installed each time the system is booted to be effective. You can use this playbook to
# install the script after booting.

# To use this playbook, set the HOSTS extra var with the name of the hosts or group
# you wish to modify:
# ansible-playbook -e HOSTS=web,mail,ns1 CVE-2021-4034_stap_mitigate.yml
#
# To verify that the script is installed, issue the command `lsmod` and look for
# `stap_pkexec_block` in the list of loaded modules.
#
# To remove the script after a fixed package has been installed, find the process ID of
# systemtap with pgrep or ps, for example:
#
#  [root@host ~]# ps $(pgrep stap)
#  23344
#
# Then, kill the systemtap process with the SIGTERM signal:
#
#  [root@host ~]# kill -s SIGTERM 23344
#
# Alternatively, you can reboot the system. When no longer needed,
# /root/pkexec-block.stp and /root/pkexec-block.log can be removed.

- name: "[TEMPORARY MITIGATION] Block pkexec with empty first argument with systemtap"
  hosts: "tag_Type_RHEL8"
  become: true
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldXWlFhbTg0ZG5jMU9FUXJhalZ3VGtGUmFteFNVUzhyVFdwNGJG
      aEVWWGxpYnpZeWEwZDBaVlJHY3pVemJuTkVaMEZoU25semFrMEtZMHBXZEZCSFkySTJSRzVKWmxW
      UGJrMW1Ua280Um1oU1pEbHJja2gyYW1abVpEbGFTVEl5WjFaWVJtSjRVa0ZTUVhvNWF6Tldhbmxx
      VDNkRmVYTXlkZ3BwYzNSRFJYUlNTbFJIWjNoMlVVbG5hbHBITDBoUmJVZFFaR1ZHVXpJNFpIRm5N
      VXBuTUcxbVprNXdlbWxWYTJwRkwxWmFSV2xTYkRSTlVHWXJiSGhUQ20xd1pUUTJiVXhpWTFGdFEw
      WlRlRGczT0ZkdU9UUTJUWEpuUjFKRVEwOVhUMUJJZUc1T1FrbFZiR2gzSzBsMVprWnJhMUZqY2l0
      RGRHNXVLMkZNUVZFS2NVeFhaVVZuTW5nMk4yTndiVWx5ZFUxMFJXRjVTa2h0WVRSUGExWk1iVGMw
      Wkhwc1ZVVTNMMlpZTUdRNFdEaEJkazVGUW5CNk0yOUtkVVp4VTNoNlFncFdkM28yZWpacWREUnph
      MVE0WlhwaFdsazJPVlp2ZFdKa1QwMVZUbFZQTjNSVldWVkxlRXRLVW1JeGVVaERSMGd5YVRaWFFs
      VjBORzVpVFZwTmJsRnNDbVZCUldkbldYTXhRM0J3TmxaMFVGVmhMMG95SzJJMVlVaGtTbU5GTHk5
      eE1VczNVVVYxUkU0eFlqUjVWWEZpZUhNNE5IVkVZa0Z5V0doSVNtUTRNU3NLVDJkb1RqRlVMM0F3
      V1VkNlpHSjBSbkp3T0RkNmVrMVlURU5MYXpKNVdsaFRNVVppUW1kbVRIVjBlbnBYUzFkcmFrdE1l
      V001TTNkVVdGTlBXWFYzZUFwWVpVaGtlWE5wYjIxa04yNW1WMFJ1WVZCVlJsQk1SakpRVTJkeVNT
      czJUVWx0VDB0eFNtRkJUbFpMZDA1VFpXSklhblEwTjB4aEszUmlSV2h4U1dod0NsaFVVbG8wTDFn
      cldVRk5VVmd4WlVWVmFXOW9kbEpsWlRaVWR6TkJNV3hDUzBkRk1uVnFSbGgwUkhoRmFFTkZRVVJD
      TmtJNVdsSXdOa2xoTjI0MmN6QUtjVWRUV0ZGVlNqVlVkM0Z1UWpJMmJUbHVObG94VGxaVVMwZHRS
      V0l6YnpWT2VtVTRaMHBJTjFReUswMDNXak5hUm1SaldtMTRaRGRuUjIwMlExVklSd3BWUzB3NVdE
      bHZUMVJUV1QwS1BXUklWa2NLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==

  tasks:
    - name: Install systemtap packages
      yum:
        name:
          - systemtap
          - yum-utils
          - kernel-devel-{{ ansible_kernel }}

    - when: ansible_distribution_major_version == '7'
      name: (RHEL 7) Install kernel debuginfo
      command: debuginfo-install -y kernel-{{ ansible_kernel }}

    - when: (ansible_distribution_major_version == '6' or ansible_distribution_major_version == '8')
      name: (RHEL 6/8) Install polkit debuginfo
      command: debuginfo-install -y polkit

    # RHEL6 with SELinux enabled needs libselinux-python for Ansible copy operation to work.
    - when: ansible_distribution_major_version == '6'
      name: (RHEL 6) Install libselinux-python
      yum:
        name:
          - libselinux-python

    - name: Create systemtap script
      copy:
        dest: /root/pkexec-block.stp
        owner: root
        group: root
        mode: "0600"
        force: false
        content: |
          probe process("/usr/bin/pkexec").function("main")  {
            if (cmdline_arg(1) == "")
              raise(9);
          }

    - name: Checking if stap_pkexec_block module is already loaded
      command: grep -Fq stap_pkexec_block /proc/modules
      register: loaded_module
      changed_when: false
      failed_when: loaded_module.rc == 2
      check_mode: false

    - when: loaded_module.rc == 1
      name: Install systemtap script
      command: stap -F -o /root/pkexec-block.log -S 1 -m stap_pkexec_block -g /root/pkexec-block.stp
      register: stap_run
      failed_when: false

    - when: stap_run.rc |default(0) != 0
      fail:
        msg: "The systemtap script could not be installed. If this system has Secure Boot enabled, a signed kernel module must be generated to use this mitigation. See the Security Bulletin for more information."

- name: run insights
  hosts: "ip-10-10-0-158.us-east-2.compute.internal,ip-10-10-11-185.us-east-2.compute.internal"
  become: true
  gather_facts: false
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRaXR6ZG5jMU9FUXJhalZ3VGtGUmFXdDRaeTh2WmtaRFoz
      QXlTblIxVEd0UU5qQnNTa3BZYm1GU1JGTjVjVVYwU0ZSNlRGY0tOVlZSVlc5MWEyUmpVRFJVUlZn
      d01EaDFhRkJHUzFaSmVrdFVTR2RsYTFOaU1UUXlkMjlQYm5sR2VUUnpRbEJrZEZoaGREVlliWEp0
      VGxsR1EwaEVWZ28xYVhSdlNrcDBPVzg1UWtkQlJVaDVZMFJ3SzBoNVNqWXphM0paZVRGUk1rOXVU
      azF3VjJaSmNtYzJUakJXVTJoa1JtVk1lR0ppTjBaMlpFaEpjbFo2Q2pJNGFrdHhOemx1Tm13eUx6
      aDZZVkJSTDFkWVZIWkNaMDVhUkVWTFJ6TmhSSFl3WVRkbWIyUnlPRWhEZGxseE5tNUhNRkZOY1RO
      U1ZFOXBkbFZtTTFnS1JuQnlhVTh2TDNKSlRDOVlSelE1TTA1NGFWSjBRakVyZEhSUk0wZHNhM1ZE
      ZFVwck1EQkdaREp0ZDNZNFprRnZaR2xUUW5aelQydEpZekZyV25adFN3cEJjR3BEY1ZKMWVHaExU
      MDgzYWxZM1FYSnRTV0p6TkhobVJrUkJVMkZaV2t4R01VMHZhME42ZWs1d1MwTjFhbE5hVUUxRlVt
      WlhhV2RHVGpGMWRqRjNDalpQSzB0b1pTdFJVRU5hUm5CV1kwVndSbTFSTVdwcWFrOVFPV2haSzNW
      alZWSnhSVEkyTlhGTWRuWnFSWE4wUW5WQk4xQkZNRVZ3UkRsaU5VaFZSM1lLTkZKemJXc3pNbFpC
      Vnl0WE5IWk1VRWQwZG1sQ00wSXpUbE0wZUhCdVIzSmlObGs1Y1cwNFZuVTJSRUZIV2xOYWRsbFlk
      bWQwTm1WR2N6RTVTVFZZUWdvMGVtcFVSRUlyTW1sT2NrcE9jM2d5YURoU1VGVnJMMmhZUzFKMGEy
      WnZZMlpKZVRkcGNWY3hiMGRsTlZSMmFqTTFSbXRqUld0YU9VRnpSMjl6WXpWMENuUlZkVlZJWWpS
      ME5EVTFSSE5EWlZWc1ZEZFNOakJDTTB4d1Z6TmlTRTF0YzFCMEx6RktNRFEwYm1KS2RFTkhUM1Jy
      UVVWWVRsVTJlbGxUTDNBMFFqSUtaSFYxY2tZdlNHUnFWWFJNVDNSdlNFTnlZVWd2WkZwaFRVNTZk
      MVZpZUc1VFZXUkdZU3R6TTBaNFJHczFVVkU0VVRaMVVucFpRbWw0WkcxeWREZGpUQXBKYTA1NlEy
      aHBRMDlrY3owS1BVMVZOMk1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false
